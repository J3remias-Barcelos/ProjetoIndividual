<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>

    <!-- BoxIcons Para ter Icones na Página -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <!-- FAVICON X -->
    <link rel="shortcut icon" href="../assets/icon/your-logo.png" type="image/x-icon">

    <!-- CANVAS PARA EXIBIR O GRÁFICO -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- CSS DA MINHA PAGE -->
    <link rel="stylesheet" href="./css/dashboardX.css">

    <!-- CHAMANDO MEU ARQUIVO JS -->
    <!-- <script src="./js/cofre.js"></script> -->
</head>

<body>
    <!-- HEADER PAGE -->
    <header class="header">
        <div>
            <a href="./dashboard.html" class="logo">Dashboard <span class="span-cor">X</span></a>
        </div>

        <div class="navbar">
            <a href="./project.html">Educação</a>
            <a href="./cofre.html" class="">Controle Financeiro</a>
        </div>
    </header>

    <!-- MAIN PAGE -->
    <main class="page-context">

        <!-- PÁGINA DO SITE DASHBOARD -->
        <div class="navigation">
            <ul>
                <li class="list">
                    <a href="./cofre.html">
                        <span class="icon"><i class='bx bx-money-withdraw'></i></span>
                        <span class="title">Control</span>
                    </a>
                </li>
                <li class="list active">
                    <a href="./dashboard.html">
                        <span class="icon"><i class='bx bxs-dashboard'></i></span>
                        <span class="title">Dashboard</span>
                    </a>
                </li>
                <li class="list">
                    <a href="./acoes.html">
                        <span class="icon"><i class='bx bxs-landmark'></i></span>
                        <span class="title">Ações</span>
                    </a>
                </li>
                <li class="list">
                    <a href="./index.html">
                        <span class="icon"><i class='bx bx-exit'></i></span>
                        <span class="title">Sair</span>
                    </a>
                </li>
            </ul>
        </div>


        <!-- CONTEÚDO DA PAGINA DASHBOARD -->
        <div class="content">
            <h1>Gráficos do Controle Financeiro</h1>


            <p>Jere é muito legal</p> <br>

            <div class="graficos">
                <div class="grafico-container" style="width: 50rem; height: 37rem;">
                    <h2>Receita Vs Despesa</h2> <br>
                    <canvas id="chartAnalytics"></canvas>
                </div>

                <div class="grafico-container">
                    <h2>Porcentagem da Carteira</h2>
                    <canvas id="chartAnalytics2"></canvas>
                </div>
            </div>
        </div>
        </div>

    </main>

    <!-- <script src="./js/cofre.js"></script> -->
    <script src="./js/dash.js"></script>
</body>

</html>

<script>
    const list = document.querySelectorAll('.list');
    function activeLink() {
        list.forEach((item) =>
            item.classList.remove('active'));
        this.classList.add('active');
    }
    list.forEach((item) =>
        item.addEventListener('click', activeLink));


window.onload = obterDadosControleFinanceiro;

async function obterDadosControleFinanceiro() {
  try {
    const idUsuarioVar = sessionStorage.getItem("ID_USUARIO");
    const controlResponse = await fetch(`/medidas/pesquisarDashboar/${idUsuarioVar}`, { cache: 'no-store' });
    if (controlResponse.ok) {
      const controlResposta = await controlResponse.json();
      console.log(`Dados recebidos: ${JSON.stringify(controlResposta)}`);
      atualizarGraficos(controlResposta);
    } else {
      console.error('Nenhum dado encontrado ou erro na API');
    }
  } catch (error) {
    console.error(`Erro na obtenção dos dados para o gráfico: ${error.message}`);
  }
}

function plotarGraficoLinha(controlResposta) {
  console.log('Iniciando plotagem do gráfico de linha...');

  const labelsControle = ['Receita', 'Despesa'];

  const dadosGraficoLinha = {
    labels: labelsControle,
    datasets: [{
      label: 'Balanço total',
      data: [controlResposta[0].Entrada, controlResposta[0].Saída],
      fill: true,
      backgroundColor: ['#06d7c6', '#EB3B3B'],
      borderWidth: 1,
      borderColor: '#A811C2',
      tension: [-0.1, 0.1] // Valor negativo para a saída e valor positivo para a entrada
    }]
  };

  const config = {
    type: 'line',
    data: dadosGraficoLinha,
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'Balanço financeiro'
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  };

  const ctxAnalytics = document.getElementById('chartAnalytics');
  const chartAnalytics = new Chart(ctxAnalytics, config);
}

// Função para plotar o gráfico de doughnut
function plotarGraficoDoughnut(controlResposta) {
  console.log('Iniciando plotagem do gráfico de doughnut...');

  const entrada = controlResposta[0].Entrada;
  const saida = controlResposta[0].Saída;
  const caixa = entrada - saida;
  const percentual = (entrada / caixa) * 100;
  const cor = (percentual > 50) ? '#06d7c6' : '#EB3B3B';

  const chartAnalytics2 = new Chart(document.getElementById('chartAnalytics2'), {
    type: 'doughnut',
    data: {
      labels: ['Percentual do Controle'],
      datasets: [{
        label: `Porcentagem %`,
        data: [percentual], // Percentual para deixar de forma dinâmica
        backgroundColor: [cor],
        borderWidth: 1,
        borderColor: '#A811C2',
        hoverBorderColor: '#A811C2',
        hoverBorderWidth: 1,
        hoverOffset: 4,
      }],
    },
  });
}

// Função para atualizar os gráficos com dados dinâmicos
function atualizarGraficos(controlResposta) {
  console.log('Atualizando gráficos...');

  plotarGraficoLinha(controlResposta);
  plotarGraficoDoughnut(controlResposta);
}

// Chamar a função para obter e plotar os dados
obterDadosControleFinanceiro();

</script>